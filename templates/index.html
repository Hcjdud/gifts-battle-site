<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gifts Battle</title>
    <style>
        body { background: #0f0f0f; color: #fff; font-family: Arial; margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; padding: 20px; background: #1a1a1a; border-radius: 10px; }
        .balance { color: gold; font-size: 24px; }
        .cases { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .case { background: #1a1a1a; border-radius: 10px; padding: 20px; cursor: pointer; border: 1px solid #333; }
        .case:hover { border-color: gold; }
        .price { color: gold; font-size: 20px; margin: 10px 0; }
        .recent { margin-top: 30px; background: #1a1a1a; padding: 20px; border-radius: 10px; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: #1a1a1a; padding: 30px; border-radius: 20px; text-align: center; }
        .win { font-size: 40px; color: gold; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéÆ Gifts Battle</h1>
        <div class="balance" id="balance">0 ‚≠ê</div>
    </div>
    
    <div class="cases" id="cases"></div>
    
    <div class="recent">
        <h2>üî• –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–∏—è</h2>
        <div id="recent"></div>
    </div>
    
    <div class="modal" id="modal">
        <div class="modal-content">
            <h2 id="modalTitle"></h2>
            <div class="win" id="modalWin"></div>
            <button onclick="closeModal()" style="padding: 10px 30px; background: gold; border: none; border-radius: 5px;">OK</button>
        </div>
    </div>
    
    <script>
        let user = null;
        
        async function init() {
            await login();
            await loadCases();
            await loadRecent();
        }
        
        async function login() {
            let name = localStorage.getItem('username');
            if (!name) {
                name = 'user_' + Math.floor(Math.random() * 10000);
                localStorage.setItem('username', name);
            }
            
            const res = await fetch('/api/user', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: name})
            });
            
            user = await res.json();
            document.getElementById('balance').innerText = user.balance + ' ‚≠ê';
        }
        
        async function loadCases() {
            const res = await fetch('/api/cases');
            const data = await res.json();
            
            let html = '';
            data.cases.forEach(c => {
                html += `
                    <div class="case" onclick="openCase(${c.id})">
                        <h3>${c.name}</h3>
                        <p>${c.description}</p>
                        <div class="price">${c.price} ‚≠ê</div>
                        <div>üì¶ ${c.items_count} –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>
                    </div>
                `;
            });
            document.getElementById('cases').innerHTML = html;
        }
        
        async function loadRecent() {
            const res = await fetch('/api/recent-openings');
            const data = await res.json();
            
            let html = '';
            data.openings.forEach(o => {
                html += `<div>${o.username} ‚Üí ${o.item_name} +${o.win_amount}‚≠ê</div>`;
            });
            document.getElementById('recent').innerHTML = html;
        }
        
        async function openCase(id) {
            const res = await fetch(`/api/cases/${id}/open`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: user.id})
            });
            
            if (!res.ok) return alert('–û—à–∏–±–∫–∞!');
            
            const data = await res.json();
            document.getElementById('modalTitle').innerText = '–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏!';
            document.getElementById('modalWin').innerHTML = `${data.item.name}<br>+${data.win_amount} ‚≠ê`;
            document.getElementById('modal').classList.add('active');
            
            user.balance = data.new_balance;
            document.getElementById('balance').innerText = user.balance + ' ‚≠ê';
            loadRecent();
        }
        
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }
        
        init();
    </script>
</body>
</html>
